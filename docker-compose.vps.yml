# =============================================================================
# MF-Investments Docker Compose — VPS Production Configuration
# =============================================================================
# For VPS deployment with hardening. DO NOT use on TrueNAS.
#
# Usage:
#   docker compose -f docker-compose.vps.yml up -d
#   docker compose -f docker-compose.vps.yml logs -f
#   docker compose -f docker-compose.vps.yml down
#
# Prerequisites:
#   1. Copy .env.example to .env and fill values
#   2. Set REDIS_PASSWORD in .env
#   3. Set KUMA_PUSH_*_URL in .env (from Uptime Kuma Push monitors)
#   4. Configure Nginx Proxy Manager for SSL
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # MySQL Database
  # ---------------------------------------------------------------------------
  mysql:
    build:
      context: ./docker
      dockerfile: mysql.Dockerfile
    image: mf-investments-mysql
    container_name: mf-investments-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-mf_selection}
      MYSQL_USER: ${DB_USER:-mf_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-mf_password}
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - mf-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2048M
        reservations:
          memory: 1024M

  # ---------------------------------------------------------------------------
  # Redis Cache (Password Protected)
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: mf-investments-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - mf-network
    # NOTE: No ports exposed — internal Docker network only (secure by default)
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ---------------------------------------------------------------------------
  # Backend API + Frontend (Node.js) — No exposed port (NPM proxies)
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: mf-investments-app
    container_name: mf-investments-app
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Server
      NODE_ENV: production
      PORT: 4000
      TZ: Asia/Kolkata
      
      # Database (matches mysql service)
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${DB_USER:-mf_user}
      DB_PASSWORD: ${DB_PASSWORD:-mf_password}
      DB_NAME: ${DB_NAME:-mf_selection}
      
      # Security
      JWT_SECRET: ${JWT_SECRET}
      
      # SMTP / Email
      SMTP_HOST: ${SMTP_HOST:-smtppro.zoho.in}
      SMTP_PORT: ${SMTP_PORT:-465}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM:-${SMTP_USER}}
      
      # Cron Reports
      ENABLE_CRON_REPORTS: ${ENABLE_CRON_REPORTS:-true}
      CRON_REPORT_EMAIL: ${CRON_REPORT_EMAIL}
      ENABLE_TRANSACTION_SCHEDULER_REPORT: ${ENABLE_TRANSACTION_SCHEDULER_REPORT:-true}
      ENABLE_FULL_SYNC_REPORT: ${ENABLE_FULL_SYNC_REPORT:-true}
      ENABLE_AMFI_SYNC_REPORT: ${ENABLE_AMFI_SYNC_REPORT:-true}
      ENABLE_AMFI_SYNC_SCHEDULE: ${ENABLE_AMFI_SYNC_SCHEDULE:-true}
      
      # Sync & Scheduler
      ENABLE_FULL_SYNC: ${ENABLE_FULL_SYNC:-true}
      ENABLE_INCREMENTAL_SYNC: ${ENABLE_INCREMENTAL_SYNC:-false}
      MFAPI_TIMEOUT_MS: ${MFAPI_TIMEOUT_MS:-60000}
      
      # AI Mutual Fund Manager (Ollama)
      OLLAMA_ENDPOINT: ${OLLAMA_ENDPOINT:-http://192.168.1.4:11434}
      OLLAMA_MODEL_NAME: ${OLLAMA_MODEL_NAME:-qwen2.5:0.5b-instruct}
      
      # Redis Cache (Password Protected)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_ENABLED: ${REDIS_ENABLED:-true}
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Backup
      BACKUP_EMAIL: ${BACKUP_EMAIL:-Shashidhar02april@gmail.com}

      # Monitoring (Uptime Kuma Push URLs)
      KUMA_PUSH_SIP_URL: ${KUMA_PUSH_SIP_URL:-}
      KUMA_PUSH_FUND_SYNC_URL: ${KUMA_PUSH_FUND_SYNC_URL:-}
      KUMA_PUSH_AMFI_SYNC_URL: ${KUMA_PUSH_AMFI_SYNC_URL:-}
      KUMA_PUSH_BACKUP_URL: ${KUMA_PUSH_BACKUP_URL:-}

    volumes:
      - ./logs:/app/logs
      - ./backups:/app/backups
    # NOTE: Port NOT exposed to host — Nginx Proxy Manager handles external access
    networks:
      - mf-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/api/health"]
      interval: 20s
      timeout: 15s
      retries: 5
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 2048M
        reservations:
          memory: 1024M

  # ---------------------------------------------------------------------------
  # Uptime Kuma — Self-Hosted Monitoring Dashboard
  # ---------------------------------------------------------------------------
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: mf-investments-kuma
    restart: unless-stopped
    volumes:
      - kuma_data:/app/data
    ports:
      - "${KUMA_PORT:-3001}:3001"
    networks:
      - mf-network
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # ---------------------------------------------------------------------------
  # Nginx Proxy Manager (SSL + Rate Limiting)
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: mf-investments-nginx
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "${WEB_PORT:-80}:80"
    volumes:
      - ./docker/nginx-vps.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - mf-network
    deploy:
      resources:
        limits:
          memory: 128M

  # ---------------------------------------------------------------------------
  # Sync Job (Manual Only - Run with: docker compose -f docker-compose.vps.yml run --rm sync-job)
  # ---------------------------------------------------------------------------
  sync-job:
    profiles: ["manual"]
    build:
      context: .
      dockerfile: Dockerfile
    image: mf-investments-app
    container_name: mf-investments-sync
    restart: "no"
    depends_on:
      backend:
        condition: service_healthy
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${DB_USER:-mf_user}
      DB_PASSWORD: ${DB_PASSWORD:-mf_password}
      DB_NAME: ${DB_NAME:-mf_selection}
      MFAPI_TIMEOUT_MS: ${MFAPI_TIMEOUT_MS:-60000}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_ENABLED: ${REDIS_ENABLED:-true}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    networks:
      - mf-network
    command: ["node", "scripts/runSync.js"]

  # ---------------------------------------------------------------------------
  # Seed Admin Job (Manual Only)
  # ---------------------------------------------------------------------------
  seed-admin-job:
    profiles: ["manual"]
    build:
      context: .
      dockerfile: Dockerfile
    image: mf-investments-app
    container_name: mf-investments-seed-admin
    restart: "no"
    depends_on:
      backend:
        condition: service_healthy
    environment:
      NODE_ENV: production
      DB_HOST: mysql
      DB_PORT: 3306
      DB_USER: ${DB_USER:-mf_user}
      DB_PASSWORD: ${DB_PASSWORD:-mf_password}
      DB_NAME: ${DB_NAME:-mf_selection}
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - mf-network
    command: ["node", "scripts/seedAdmin.js"]

# =============================================================================
# Networks
# =============================================================================
networks:
  mf-network:
    driver: bridge

# =============================================================================
# Volumes (Persistent Storage)
# =============================================================================
volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  kuma_data:
    driver: local
